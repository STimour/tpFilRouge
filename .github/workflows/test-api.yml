name: Run API Tests with Newman

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-api:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: socialuser
          POSTGRES_PASSWORD: socialpass
          POSTGRES_DB: socialdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # ðŸŸ£ Descend dans le dossier contenant ton projet Spring Boot
      - name: Build with Maven
        run: |
          cd socialapp
          mvn clean package -DskipTests

      # ðŸŸ¢ Lancer lâ€™application en arriÃ¨re-plan
      - name: Start Spring Boot in background
        run: |
          cd socialapp
          nohup java -jar target/socialapp-0.0.1-SNAPSHOT.jar > ../app.log 2>&1 &
          sleep 20
          echo "âœ… API started"

      # ðŸŸ  Installer Newman pour exÃ©cuter les tests Postman
      - name: Install Newman
        run: npm install -g newman

      # ðŸ”µ ExÃ©cuter la collection Postman
      - name: Run Postman tests
        run: |
          newman run tests/tpFilRouge.postman_collection.json \
            --reporters cli,junit \
            --reporter-junit-export newman-results.xml

      # ðŸŸ¡ Sauvegarder le rapport comme artefact
      - name: Upload Newman test report
        uses: actions/upload-artifact@v4
        with:
          name: newman-report
          path: newman-results.xml
